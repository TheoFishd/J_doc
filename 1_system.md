[<<Оглавдение](0_index.md)
# >> Системный модуль

Содержание:
- [Админ уровень](#админ-уровень)
    - [Настройка google](#настройка-google)
    - [Настройка Open AI](#настройка-open-ai)
    - [Структура системы](#структура-системы)
        - [Администраторы системы](#администраторы-системы)
        - [Конфигурационный диск](#конфигурационный-диск)
        - [Настроечная таблица](#настроечная-таблица)
        - [Диск с информацией о клиентах](#диск-с-информацией-о-клиентах)
        
- [Код уровень](#код-уровень)
    - [Базовая логика](#базовая-логика)
    - [Инициализация системы](#инициализация-системы)
        - [Конфигурация системы](#конфигурация-системы)
        - [Получение данных из настроечной таблицы](#получение-данных-из-настроечной-таблицы)
        - [Кешируемые данные](#кешируемые-данные)
# Пользовательский уровень
Пользователи никак не взаимодействую с системной частью

# Админ уровень

### Администраторы системы
На данном этапе в систему, при ее инициализации, подаются конкретные id telegram админов системы. В рамках ассистента администраторы имеют доступ к дополнительным командам передаюзимся ассистенту через телеграм. Права доступа к `google workspace` и аккаунту `openai` не регулируются системой или ассистентом
>В будущем первым администратором будет выставляться id пользователя регестрирующего коробочную систему + у него будет возможность указать чеорез HR модуль дополнительных администраторов. Асситент будет иметь больше инструментов для управления досупами сотрудников ко всем модулям ассистента и системы.


## Настройка google
В домене компании google workspace должен быть создан рабочий и конфигурационные диски, выданы рабочие почтовые ящики настроенны доступы для рабочих аккаунтов
>В коробочной версии настройкой google будет заниматься либо сервис аккаунт по автоматизированной или ИИ логике либо Админ компании. На данном этапе все настроенно и покачто нет нужды и возможности в это погрузиться

## Настройка Open AI
На данном этапе никакой специальной настройки openai не нужно.
>Для коробочной системы администратору нужно будет получать ключ для api. Так же в текущей версии не создается автоматически общее хранилище данных. смотри [сноску к этому разделу](#базовая-логика)

## Структура системы:

Ядром системы является [конфигурационный диск](#конфигурационный-диск) в `google workspace` и [настроечная таблица](#настроечная-таблица) в `google sheets`.
> Лучшей практикой является хранение настроечной таблицы в корне конфигурационного диска, доступном только администраторам системы.  
### Конфигурационный диск

Конфигурационны диск имеет структуру обязательных папок, изменение имен которой приведет к неработоспособности системы. 
Папка `Шаблоны` содержит папки:
- `Шаблоны смет`, файлы из этой папки [кешируются](#кешируемые-данные) при инициализации и используются как шаблоны смет в процессах модулей (в данной версии - модуль создания новгого проекта). Создание новых папок внутри папки `Шаблоны смет` может повлиять на работу системы. Создание и изменение файлов в папке `Шаблоны смет` допустимо. 
- `Шаблонами тайминга` где хранится шаблон тайминга использующийся при создании проекта
- `Шаблон структуры папок проекта` - содержит структуру из пустых папок. При работе модуля [создания новго проекта](new_project.md) в папке нового проекта создается структура по образу структуры хранащейся в папке `Шаблон структуры папок проекта`.  
Изменение структуры папки `Шаблон структуры папок проекта` не нарушит работу системы, но изменит внутренюю структуру папок для всех создаваемых после изменений проектов.

В остальном на конфигурауционном диске можно создавать файлы и папки на усмотрение администратора

### Настроечная таблица
Система обращается к настроечной таблице (по google id таблицы переданной системе при [инициализации](#инициализация-системы)) за первичными данными при инициализации.  
Настроечная таблица иммеет жесткую структуру изменение которой приведет в нерабочее состояние:
- названия и порядок столбцов "описание", "имя переменной", "значение переменной"
- имена переменных в столбце "имя переменной"
- имя листа "General config"

В значение переменных в соответствии с их описанием нужно вставить ссылки на нужные системе объекты (таблицы и папки-диски). Система сама заберет из сылок нужные данные (id), при этом в настроечной таблице остается удобный способ проверки правильности заполненных данных переходом по ссылке. 

>В коробочной версии настроечная таблица будет создаваться автоматически конструктором и иметь заблокированные диапазоны. Администратору системы не придется заботится о создании правильной структуры. Нужно будет правильно указать данные в столбце "значение переменной" и только

### Диск с информацией о клиентах
Диск должен в обязательном порядке иметь папку `CLIENTS` эта папка должна находится на предоставленном при [инициализации](#инициализация-системы) ID диска общедоступного сотрудникам компании. Внутри папки `CLIENTS` в процессе работы компании создается структура папок `CLIENTS` -> `Имя_клиента`. Папка `Имя_клиента` содержит папки проектов для этого клиента компании.

### **Таблица** клиентов компании
Ссылка на **таблицу** клиентов указывается в настроечной таблице. Используется [модулем создания новых проектов](5_new_project.md#закэшированные-данные) для выбора имени клиента и приведения его к системному виду. Таблица должна содержать список имен клиентов в первой колонке нациная со второй строки на листе `"Клиенты"`

# Код уровень

>Этот раздел документации покачто в состоянии фундамента т.к. код - самая динамичная, постоянно меняющаяся, часть и погружаться в подробное полное описание логики не практично на данном этапе. Тем не менее понемногу она будет прирастать.

## Базовая логика
Система взаимодействует с внешними системами через api. Для работы с google дисками и таблицами используется сервисный аккаунт google, от мимени аккаунта администратора в домене компании. Пользовательский доступ к данным google настраивается [администратором](#настройка-google)
> dev - нужно вспомнить и записать процесс персонификации. сейчас в создании системного клиента для взаимодействия с google указана конкретная почта от чъего имени действует аккаунт, но как к этому прийдти - нужно ли что-то от админа делать в консоли cloud - забыто. 

Для [взаимодействия с telegram](3_telegram.md) как с разговорным интерфейсом используется библиотека `telethon` с низкоуровневым взаимодействием по `MTProto` вместо `http bot api`.  
Для взаимодействия с openai используется библиотека `OpenAI`. Текстовые сообщения обрабатываются на `response` эндпоинте. Для общего RAG по данным компании используется `vector store` с уникальным именем. Для RAG по персональным (присланным в ассистент) файлам пользователя используются `vector store` с именем векторстора совпадающим с id пользователя в системе ([смотри устройство HR модуля](2_hr.md))
> dev - костыль: общий `vector store` компании сейчас устанавливается по имени **"_________inhouse_knowledge_base"** поиском среди всех `vector store` привязанных к компании на openai. Если такого `vector store` нет в организации связанной с api ключем, то инициализация выдаст ошибку и прервется.  
Требуется:
 - обработать случай когда `vector store` с нужным именем отсутствует - создать `vector store` с нужным именем
 - принять решение - захардкодить имя общего `vector store` для коробочной версии или вынести его в настроечную таблицу что бы админ мог устанавливать его по своему желанию...

## Инициализация системы
В текущей версии разделена на 3 блока: 
1. Инизиализация класса `System(SystemBase)` - в текузей версии в основном отвечает за хранение сервисных объектов и данных для работы с google.
2. Кэширование сотрудников компании с словарь вида { id : `class User`} ([смотри](2_hr.md))
3. Авторизация и запуск [телеграм бота](3_telegram.md) ассистента
> В коробочной версии скорее всего будут собраны в один единый блок



Для инициализации системы должны быть подготовленны и внесены в переменные среды следующее данные:

- api ключ для openai (https://platform.openai.com/)
- ключи телеграмм апп (https://my.telegram.org/auth)
- api ключ для telegram bota (https://t.me/botfather)
- credentials google сервис аккаунта для доступа по api google (https://console.cloud.google.com/)
- id конфигурационного диска. (https://drive.google.com/drive/folders/0AI_____________PVA) - ссылка на конфигурационный диск. Id диска 0AI_____________PVA
- id ссылки конфигурационной таблицы. (рацианально хранить ее на конфигурационном диске. т.к она является источником стартовых данных для системы). (https://docs.google.com/spreadsheets/d/1RdvX_________________d2c/) - ссылка на таблицу. id файла: 1RdvX_________________d2c


### Конфигурация системы
> dev - сюда важно внести источники получения данных для работы - имен и id дисков, файлов, таблиц что бы разобрать динамические и хардкод переменные. Для коробочной версии большинство переменных должно быть динамическое

### Получение данных из настроечной таблицы
**ВАЖНО:** Все переменные установленные в [настроечной таблице](#настроечная-таблица) в столбце `имя переменной` должны быть аннотированы в [class_system.py](../class_system.py) в классе `SystemBase` иначе они не пройдут проверку и не инициализируюися.
> dev - Идея опираться на соответствие имен переменных в коде со заначением полей в таблице мне не очень нравится. Конструкторское решение требуется.

### Кешируемые данные
Описание процесса кеширования и последующего использования кэша.