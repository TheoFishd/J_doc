# >> Openai обработчик + модуль обертки ChatGPT

Содержание:
- [Пользовательский уровень](#пользовательский-уровень)
    - [Общие принцыпы](#общие-принцыпы)
    - [Создание нового проекта](#создание-нового-проекта)
    - [Общий вопрос ассистенту](#общий-вопрос-ассистенту)
- [Админ уровень](#админ-уровень)
    - [Управление аккаунтом openai](#управление-аккаунтом-openai)
    - [Контекст пользователя](#контекст-пользователя)
- [Код уровень](#код-уровень)

# Пользовательский уровень
## Общие принцыпы
Все запросы пользователя поступающие в ассистента через обработчик [телеграм](3_telegram.md) в первую очередь попадают на уровень ассистента который оценивает входящее сообщение и принимает решение как обрабатывать это сообщение дальше. На этом уровне ассистент относит намеренье пользователя к одному из вариантов:
- Пользователь хочет создать новый проект в системе или сообщение имеет отношение к процессц создания нового проекта
- Пользователь задает общий вопрос ассистенту

После чего отправляет сообщение пользователя в соответствующий обработчик
> **Примечание**: перед классификацией запроса, ассистент проверяет входящие из [телеграм](3_telegram.md) данные и если входящие данные это голосовое сообщение, то сначала ассистент транскрибирует его на русский язык, возвращает транскрибацию в телеграм, что бы пользователь мог видеть какой текст ассистент получил в виде запроса, после чего приступает к классификации сообщения  
Если входящие данные из телеграм содержат картинку, ассистент, не классифицируя сообщение, использует `vision` и возвращает ответ напрямую в телеграм. Тоесть елси попросить создать проект и прикрепить картинку к сообщению, сообщени не пройдет классификацию и у ассистента не будет возможности передать управление модулю создания нового проекта.

## Создание нового проекта
Что бы создать новый проект в системе, польователь должен составить сообщение ассистенту таким образом что бы классификатор ассистента понял что намеренье пользователя - создать новый проект в системе.  
Если ассистент верно классифицировал намеренье пользователя, он извлечет данные нужные для создания проекта из сообщения пользователя, если такие были в сообщении и сгенерирует ответ в котором укажет какие данные нужные для создания нового проекта у него уже есть и подскажет какие данные еще пользователю нужно предоставить. В ходе беседы с асситентом пользователь может просить ассистента менть уже собранные данные, если того требует ситуация. 
Когда все нужные данные предоставлены [модуль создания нового проекта](5_new_project.md) сгенерирует сообщение в телеграм с кнопкой подтверждения данных. Нажав на которую, пользователь запустит работу модуля в функции которого входит создание папки нового проекта в папке клиента и структуры подпапок, создание записи в таблице проектов, создание проекта в бейскем и рассылку пуш уведомлений. 

## Общий вопрос ассистенту
Если запрос пользователя не имеет отношения к процессу создания нового проекта, он отправляется в обработчик общих запросов. Обработчик общих запросов имеет следующий набор инструментов:
- поиск в интернете
- поиск по доступным векторным базам:
    - общая база регламентов компании
    - хранилище персональных файлов загруженных в векторстор
- анализ картинок
Openai самостоятельно решает какие инструменты применять при обработке запроса 

# Админ уровень
Администрирование модуля производится на https://platform.openai.com/
## Управление аккаунтом openai
Cостояние счета: https://platform.openai.com/settings/organization/billing/overview  
Лимиты и лимитный tier для организации: https://platform.openai.com/settings/organization/limits

## Контекст пользователя
На данный момент для администратора доступна возможность посмотреть окно контекста пользователя используя значение поля `Conv_id` пользователя с листа `Сотрудники` [таблицы сотрудников](2_hr.md#общие-принцыпы) введя его в поиск на странице https://platform.openai.com/logs?api=conversations.
> **Примечание**: Контекст пользователя это не вся переписка пользователя с ассистентом, а актуальное контекстное окно, которое постоянно подрезается что бы оставаться в рамках лимитов openai


# Код уровень
> Структурно сейчас модуль создания нового проекта работает в двух разных модулях. ИИ логика сбора информации находится в [модуле oia](/oai.py), а логика создания проекта в модуле [нового проекта](/class_project.py). для конструктора будет понятнее если код будет разделен по системным модулям, тоесть вся логика относящаяся к модулю будет в одном файле или паке.

> dev - несмотря на то что персональные файлы имеют установленное время хранения, ссылки на них не удаляются из векторсторов, что возможно влияеь на контектс. при кэшировании пользователей предлагается подчищать ссылки в векторсторах, так же хорошей практикой будет удалять из контекста манифесты о загруженных файлах из контекста о тех файлах срок хранения которых истек 
