[<<Оглавление](0_index.md)
# >> OpenAI обработчик + модуль обёртки ChatGPT

Содержание:
- [Пользовательский уровень](#пользовательский-уровень)
    - [Общие принципы](#общие-принципы)
    - [Создание нового проекта](#создание-нового-проекта)
    - [Общий вопрос ассистенту](#общий-вопрос-ассистенту)
- [Админ уровень](#админ-уровень)
    - [Управление аккаунтом OpenAI](#управление-аккаунтом-openai)
    - [Контекст пользователя](#контекст-пользователя)
- [Код уровень](#код-уровень)

# Пользовательский уровень
## Общие принципы
Все запросы пользователя, поступающие в ассистента через обработчик [телеграм](3_telegram.md), в первую очередь попадают на уровень ассистента, который оценивает входящее сообщение и принимает решение, как обрабатывать это сообщение дальше. На этом уровне ассистент относит намерение пользователя к одному из вариантов:
- Пользователь хочет создать новый проект в системе, или сообщение имеет отношение к процессу создания нового проекта
- Пользователь задаёт общий вопрос ассистенту

После чего ассистент отправляет сообщение пользователя в соответствующий обработчик.  
> **Примечание**: перед классификацией запроса ассистент проверяет входящие из [телеграм](3_telegram.md) данные, и если это голосовое сообщение, то сначала ассистент транскрибирует его на русский язык, возвращает транскрибацию в телеграм, чтобы пользователь мог видеть, какой текст ассистент получил в виде запроса, после чего приступает к классификации сообщения.  
Если входящие данные из телеграм содержат картинку, ассистент, не классифицируя сообщение, использует `vision` и возвращает ответ напрямую в телеграм. То есть если попросить создать проект и прикрепить картинку к сообщению, сообщение не пройдёт классификацию, и у ассистента не будет возможности передать управление модулю создания нового проекта.

## Создание нового проекта
Чтобы создать новый проект в системе, пользователь должен составить сообщение ассистенту таким образом, чтобы классификатор ассистента понял, что намерение пользователя — создать новый проект в системе.  
Если ассистент верно классифицировал намерение пользователя, он извлечёт данные, нужные для создания проекта, из сообщения пользователя (если такие были в сообщении) и сгенерирует ответ, в котором укажет, какие данные для создания нового проекта у него уже есть, и подскажет, какие данные ещё пользователю нужно предоставить. В ходе беседы с ассистентом пользователь может просить ассистента менять уже собранные данные, если того требует ситуация.  
Когда все нужные данные предоставлены, [модуль создания нового проекта](5_new_project.md) сгенерирует сообщение в телеграм с кнопкой подтверждения данных. Нажав на неё, пользователь запустит работу модуля, в функции которого входит создание папки нового проекта в папке клиента и структуры подпапок, создание записи в таблице проектов, создание проекта в Basecamp и рассылка push-уведомлений. 

## Общий вопрос ассистенту
Если запрос пользователя не имеет отношения к процессу создания нового проекта, он отправляется в обработчик общих запросов. Обработчик общих запросов имеет следующий набор инструментов:
- поиск в интернете
- поиск по доступным векторным базам:
    - общая база регламентов компании
    - хранилище персональных файлов, загруженных в векторстор
- анализ картинок  

OpenAI самостоятельно решает, какие инструменты применять при обработке запроса. 

# Админ уровень
Администрирование модуля производится на https://platform.openai.com/

## Управление аккаунтом OpenAI
Состояние счёта: https://platform.openai.com/settings/organization/billing/overview  
Лимиты и лимитный tier для организации: https://platform.openai.com/settings/organization/limits

## Контекст пользователя
На данный момент для администратора доступна возможность посмотреть окно контекста пользователя, используя значение поля `Conv_id` пользователя с листа `Сотрудники` [таблицы сотрудников](2_hr.md#общие-принципы), введя его в поиск на странице https://platform.openai.com/logs?api=conversations.  
> **Примечание**: Контекст пользователя — это не вся переписка пользователя с ассистентом, а актуальное контекстное окно, которое постоянно подрезается, чтобы оставаться в рамках лимитов OpenAI.

# Код уровень
> Структурно сейчас модуль создания нового проекта работает в двух разных модулях. ИИ-логика сбора информации находится в [модуле oai](/oai.py), а логика создания проекта — в модуле [нового проекта](/class_project.py). Для конструктора будет понятнее, если код будет разделён по системным модулям, то есть вся логика, относящаяся к модулю, будет в одном файле или пакете.

> dev — несмотря на то что персональные файлы имеют установленное время хранения, ссылки на них не удаляются из векторсторов, что возможно влияет на контекст. При кэшировании пользователей предлагается подчищать ссылки в векторсторах. Также хорошей практикой будет удалять из контекста манифесты о загруженных файлах, срок хранения которых истёк.
